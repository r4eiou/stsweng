<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
<script src="/js/sweetalert.min.js"></script>
<script src="/js/webcam.min.js"></script>
<script src="/js/print.js"></script>
<script src ="/js/header.js"></script>

<link rel = "stylesheet" type="text/css" href="/css/back-button.css">
<link rel = "stylesheet" type = "text/css" href = "/css/index.css">
<link rel = "stylesheet" type = "text/css" href = "/css/input-details-page.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

<div class="main-container" id="main-container">
    <div class= "header" id="header">
        <div class = "header-left">
            <a href="/index" class="header-logo-link" id="home-link1"><img src="/images/logo.png" class="header-logo"></a>
            <a href="/index" class="header-home" id="home-link2"><p class="leftTitle">Home</p></a>
        </div>
        
        {{!-- <div class = "">
            <div class = "header-text">
                <h3>Sangguniang Barangay ng Parang</h3>
                <h5>Marikina City</h5>
            </div>
        </div> --}}

        <div class="midHeader">
            <p class="title">Sangguniang Barangay ng Parang</p>
            <p class="title-place" >Marikina City</p>
        </div>
        
        
        <div class="header-right">
            <div class="header-user-profile">
                <span class="header-user-profile-text" id="profile-text">Employee</span>
                <img src="/images/employee-profile.png" class="header-user-profile" id="profile-img">
            </div>
            <button type="button" class="header-logout-btn" id="logout-btn">Logout</button>
        </div>
    </div>
    
    <div class = "upper-container" id="form-upper-container">
        <div class="back-and-title">
            <a href="/employee-home" class="back-button" id="white-back-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white" class="size-4">
                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8Zm10.25.75a.75.75 0 0 0 0-1.5H6.56l1.22-1.22a.75.75 0 0 0-1.06-1.06l-2.5 2.5a.75.75 0 0 0 0 1.06l2.5 2.5a.75.75 0 1 0 1.06-1.06L6.56 8.75h4.69Z" clip-rule="evenodd"/>
                </svg>
                Back
            </a>
        </div>
    </div>

    <div class="sub-container">
        
        <div class = "text-container">
            <div class="action-text">Please input your details below to proceed with certification printing.</div>
        </div>

        <form action="/submit-certificate" method="post" class="print-form">
            <div class = "print-panel">
                <!-- for Photo-->
                <div class="photo-container">
                    <img src="/images/customer.png" class="details-profile" id="deets-profile-img">
                    <button type="button" class="image-upload-button" id="accesscamera" data-toggle="modal" data-target="#photoModal">Capture Photo</button>
                </div>
                
                <!-- Modal for Webcam -->
                <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Capture Photo</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div id="my_camera" class="d-block mx-auto rounded overflow-hidden"></div>
                                <div id="results" class="d-none"></div>
                                <form method="post" id="photoForm">
                                    <input type="hidden" id="photoStore" name="photoStore" value="">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-warning mx-auto text-white" id="takephoto">Capture Photo</button>
                                <button type="button" class="btn btn-warning mx-auto text-white d-none" id="retakephoto">Retake</button>
                                <button type="button" class="btn btn-warning mx-auto text-white d-none" id="uploadphoto">Upload</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- for Name and Birthday-->
                <div class="deets1-container">
                    <div class="name-container">
                        <div class="deets-text">Name</div>
                        <input type="text" id="name" name="name" placeholder="Juan C. Dela Cruz">
                    </div>

                    <div class="date-container">
                        <div class="deets-text">Birthday</div>
                        <input type="Date" id="Birthday" class="date" name="bday-date" placeholder="MM/DD/YYYY">                             
                    </div>
                </div>

                <!-- for Address -->
                <div class="deets2-container">
                    <div class="address-container">
                        <div class="deets-text">Address</div>
                        <input type="text" id="address" name="address" placeholder="">
                    </div>
                </div>

                <!-- for Place of Birth and Place of Issuance -->
                <div class="deets3-container">
                    <div class="birthplace-container">
                        <div class="deets-text">Place of Birth<span> (City)</span></div>
                        <input type="text" id="birthplace" name="birthplace" placeholder="Marikina City">                             
                    </div>
                    

                    <div class="location-container">
                        <div class="deets-text">Place of CTC Issuance<span> (City)</span></div>
                        <input type="text" id="location" name="location" placeholder="Marikina City">
                    </div>
                </div>

                <!-- for Cedula Number and CTC Issuance Date -->
                <div class="deets4-container">
                    <div class="cedula-container">
                        <div class="deets-text">CTC Number</div>
                        <input type="text" id="cedula" name="cedula" placeholder="12345678">
                    </div>

                    <div class="date-container">
                        <div class="deets-text">CTC Issuance Date</div>
                        <input type="Date" id="ctc-date-issued" class="date" name="ctc-date" placeholder="MM/DD/YYYY">                             
                    </div>
                </div>

                <!-- for Reason For Certificate -->
                <div class="deets5-container"> 
                    <div class="deets-text">Reason For Certificate</div>
                    <input type="text" id="reason" name="reason" placeholder="">
                </div>

                <div class="action-container">
                    <button type="button" class="download-btn lrg dark" onclick="downloadFileEmployee()"><img src="/images/download-dark.png"><span>Download</span></button>
                    <button type="button" class="cancel-btn light" onclick="cancelForm()"><img src="/images/cancel-light.png"><span>Cancel</span></button>
                </div>
            </div>
        </form>
    </div>

</div>

<div id="validationModal" class="modal">
    <div class="modal-content">
        {{!-- <span class="close">&times;</span> --}}
        <p id="modalMessage"></p>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    function titleCase(str) {
        return str.toLowerCase().split(' ').map(function(word) {
            return word.replace(word.charAt(0), word.charAt(0).toUpperCase());
        }).join(' ');
    }
    
    async function downloadFileEmployee() 
    {
        // Perform validation
        const isValid = await validateForm();
        
        // If validation fails, exit the function
        if (!isValid) {
            return;
        }

        const form = document.querySelector('.print-form');
        const name = titleCase(form.elements['name'].value);
        const birthday = formatBirthday(form.elements['bday-date'].value);
        const address = titleCase(form.elements['address'].value);
        const ctcDateIssued = formatBirthday(form.elements['ctc-date'].value);
        const location = titleCase(form.elements['location'].value);
        const cedula = form.elements['cedula'].value;
        const birthPlace = titleCase(form.elements['birthplace'].value);
        const reason = form.elements['reason'].value.toUpperCase();
        const profileImg = document.getElementById('deets-profile-img').src;

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
        const dd = String(today.getDate()).padStart(2, '0');

        const formattedDate = `${yyyy}-${mm}-${dd}`;
        const certDateIssued = formatBirthday(formattedDate);

        //send data
        const data = {
            name,
            birthday: form.elements['bday-date'].value,
            address,
            birthPlace,
            ctc_no: cedula,
            ctc_date_issued: form.elements['ctc-date'].value,
            ctc_location: location,
            cert_date_issued: formattedDate,
            reason,
            img: profileImg
        };

        //console.log(JSON.stringify(data));
        
        fetch('/saveCertificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            console.log('Success:', result);
        })
        .catch(error => {
            console.log("error here fetch")
            console.error('Error:', error);
        });

        //generating part
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: [215.9, 279.4]  // width, height
        });

        doc.setFont('Times', 'bold'); 

        // Title and Header
        
        const logoWidth = 100;
        const logolength = 30;
        doc.addImage('/images/logo-cert.png', 'PNG', 57, 10, logoWidth, logolength);

        doc.setFontSize(12);
        doc.text('Republic of the Philippines',     105, 45, null, null, 'center');
        doc.text('City of Marikina',                105, 50, null, null, 'center');
        doc.setFontSize(14);
        doc.text('BARANGAY PARANG',                 105, 56, null, null, 'center');
        doc.setFontSize(16);
        doc.text('OFFICE OF THE PUNONG BARANGAY',   105, 66, null, null, 'center');
        doc.setFontSize(20);

        doc.text('C E R T I F I C A T I O N',       105, 76, null, null, 'center');
        var textWidth = doc.getTextWidth('C E R T I F I C A T I O N');
        doc.setLineWidth(0.5);
        doc.line(105 - textWidth / 2, 77, 105 + textWidth / 2, 77);

        // Body Text

        const imgWidth = 30;
        const imgHeight = 30;
        doc.addImage(profileImg, 'JPEG', 170, 85, imgWidth, imgHeight);

        doc.addImage('/images/sign-box-cert.png', 'PNG', 168, 118, 35, 35);

        doc.setFont("Times", "normal");
        doc.setFontSize(14);
        doc.text('To whom it may concern;',             20, 90);
        doc.text(`This is to certify the fact that`,    20, 102);

        // NAME BOLD
        doc.setFont("Times", "bold");
        doc.text(`${name}`,                             79, 102);
        textWidth = doc.getTextWidth(`${name}`);
        doc.setLineWidth(0.5);
        doc.line(79, 103, 79 + textWidth, 103);
        doc.setFont("Times", "normal");

        doc.text(`born on the`,            20, 108);

        // BIRTHDAY BOLD
        doc.setFont("Times", "bold");
        doc.text(`${birthday}`,                             44, 108);
        textWidth = doc.getTextWidth(`${birthday}`);
        doc.setLineWidth(0.5);
        doc.line(44, 109, 44 + textWidth, 109);
        doc.setFont("Times", "normal");

        doc.text(`at`,   45 + textWidth, 108);

        // Birthplace BOLD
        doc.setFont("Times", "bold");
        doc.text(`${birthPlace}`,                       50 + textWidth, 108);
        textWidthBP = doc.getTextWidth(`${birthPlace}`);
        doc.setLineWidth(0.5);
        doc.line(50 + textWidth, 109, 50 + textWidthBP + textWidth, 109);
        doc.setFont("Times", "normal");

        doc.text(`, whose picture`,  51 + textWidthBP + textWidth, 108);

        doc.text(`and signature appears, is a bonafide resident of Barangay Parang,`,  20, 114);
        //doc.text(`currently residing at`,                                              20, 120);

        /*
        // ADDRESS BOLD
        doc.setFont("Times", "bold");
        doc.text(`${address}`, 61, 120);
        textWidth = doc.getTextWidth(`${address}`);
        doc.setLineWidth(0.5);
        doc.line(61, 121, 61 + textWidth, 121);
        doc.setFont("Times", "normal");
        */

        var addressReason = "currently residing at ";
        var splitTextAdd = doc.splitTextToSize(address, 100);

        var yPos = 120;

        // Set font to normal and add reasonText
        doc.setFont("Times", "normal");
        doc.text(addressReason, 20, yPos);

        var addressReasontWidth = doc.getTextWidth(addressReason);

        doc.setFont("Times", "bold");
        for (var i = 0; i < splitTextAdd.length; i++) {
            var line = splitTextAdd[i];
            var xPos = 20;

            // For the first line, add it after the reasonText
            if (i === 0) {
                xPos += addressReasontWidth;
                doc.text(line, xPos, yPos);

                var lineWidth = doc.getTextWidth(line);
                doc.line(xPos, yPos + 1, xPos + lineWidth, yPos + 1);
            } else {
                // For subsequent lines, add them normally with the same indentation
                yPos += 6; // Line height
                doc.text(line, xPos, yPos);

                var lineWidth = doc.getTextWidth(line);
                doc.line(xPos, yPos + 1, xPos + lineWidth, yPos + 1);
            }
        }

        doc.setFont("Times", "normal");
        doc.text(`and that he/she exhibited to me his/her Community Tax`,   20, 120 + (splitTextAdd.length * 6));
        doc.text(`Certificate No. `,                                        20, 126 + (splitTextAdd.length * 6));

        // CEDULA NO. BOLD
        doc.setFont("Times", "bold");
        doc.text(`${cedula}`, 50, 126 + (splitTextAdd.length * 6));
        textWidth = doc.getTextWidth(`${cedula}`);
        doc.setLineWidth(0.5);
        doc.line(50, 127 + (splitTextAdd.length * 6), 50 + textWidth, 127 + (splitTextAdd.length * 6));
        doc.setFont("Times", "normal");

        doc.text(`issued at`, 71, 126 + (splitTextAdd.length * 6));

        // CEDULA NO. BOLD
        doc.setFont("Times", "bold");
        doc.text(`${location}`, 89, 126 + (splitTextAdd.length * 6));
        textWidth = doc.getTextWidth(`${location}`);
        doc.setLineWidth(0.5);
        doc.line(89, 127 + (splitTextAdd.length * 6), 89 + textWidth, 127 + (splitTextAdd.length * 6));
        doc.setFont("Times", "normal");

        doc.text(`on the`, 90 + textWidth, 126 + (splitTextAdd.length * 6));

        //
        doc.setFont("Times", "bold");
        doc.text(`${ctcDateIssued}.`, 20, 132 + (splitTextAdd.length * 6));
        textWidth = doc.getTextWidth(`${ctcDateIssued}`);
        doc.setLineWidth(0.5);
        doc.line(20, 133 + (splitTextAdd.length * 6), 20 + textWidth, 133 + (splitTextAdd.length * 6));
        doc.setFont("Times", "normal");


        doc.text(`This certification is hereby issued to the above mentioned individual for the`, 20, 145 + (splitTextAdd.length * 6));
        var reasonTexct = "for the fulfillment of"

        //doc.text(`for the fulfillment of `, 20, 161);

        /*
        doc.setFont("Times", "bold");
        doc.text(`${reason}.`, 63, 161);
        textWidth = doc.getTextWidth(`${reason}`);
        doc.setLineWidth(0.5);
        doc.line(63, 162, 63 + textWidth, 162);
        doc.setFont("Times", "normal");
        */
        var reasonText = "fulfillment of ";
        var splitText = doc.splitTextToSize(reason, 125);

        var yPos = 151 + (splitTextAdd.length * 6);

        // Set font to normal and add reasonText
        doc.setFont("Times", "normal");
        doc.text(reasonText, 20, yPos);

        var reasonTextWidth = doc.getTextWidth(reasonText);

        doc.setFont("Times", "bold");
        for (var i = 0; i < splitText.length; i++) {
            var line = splitText[i];
            var xPos = 20;

            // For the first line, add it after the reasonText
            if (i === 0) {
                xPos += reasonTextWidth;
                doc.text(line, xPos, yPos);

                var lineWidth = doc.getTextWidth(line);
                doc.line(xPos, yPos + 1, xPos + lineWidth, yPos + 1);
            } else {
                // For subsequent lines, add them normally with the same indentation
                yPos += 6; // Line height
                doc.text(line, xPos, yPos);

                var lineWidth = doc.getTextWidth(line);
                doc.line(xPos, yPos + 1, xPos + lineWidth, yPos + 1);
            }
        }
    
        doc.setFont("Times", "normal");
        doc.text(`This was issued on the`, 20, 151 + (splitText.length * 6) + (splitTextAdd.length * 6));
        
        
        // CERT DATE ISSUE BOLD
        doc.setFont("Times", "bold");
        doc.text(`${certDateIssued}`, 66, 151 + (splitText.length * 6) + (splitTextAdd.length * 6));
        textWidth = doc.getTextWidth(`${certDateIssued}`);
        doc.setLineWidth(0.5);
        doc.line(66, 152 + (splitText.length * 6) + (splitTextAdd.length * 6), 66 + textWidth, 152 + (splitText.length * 6) + (splitTextAdd.length * 6));
        doc.setFont("Times", "normal");

        doc.text(`at Barangay`, 67 + textWidth, 151 + (splitText.length * 6) + (splitTextAdd.length * 6));
        doc.text(`Parang, Marikina City.`, 20, 157 + (splitText.length * 6) + (splitTextAdd.length * 6));

        // Signature
        doc.addImage('/images/footer-cert.png', 'PNG', 20, 200, 155, 75);
        

        // Open PDF in a new window
        // doc.output('dataurlnewwindow');

        var pdfBlob = doc.output('blob');
        var url = URL.createObjectURL(pdfBlob);
        var newWindow = window.open(url, '_blank');

        if (newWindow) {
            newWindow.document.title = "certificate.pdf";
        }
    }
</script>
